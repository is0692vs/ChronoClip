<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChronoClip 設定</title>
    <link rel="stylesheet" href="options.css" />
  </head>
  <body>
    <header>
      <h1>🗓️ ChronoClip 設定</h1>
      <p>ウェブ上の日付をGoogleカレンダーに追加する際の動作を設定できます</p>
    </header>

    <main>
      <form id="settingsForm">
        <!-- 基本設定 -->
        <section class="setting-section">
          <h2>基本設定</h2>

          <div class="setting-item">
            <label for="autoDetect">
              <input type="checkbox" id="autoDetect" name="autoDetect" />
              自動検出を有効にする
            </label>
            <p class="description">
              ページを開いた時に日付を自動でスキャンします
            </p>
          </div>

          <div class="setting-item">
            <label for="highlightDates">
              <input
                type="checkbox"
                id="highlightDates"
                name="highlightDates"
              />
              日付をハイライト表示する
            </label>
            <p class="description">
              検出した日付にマウスオーバーで色を付けて表示します
            </p>
          </div>

          <div class="setting-item">
            <label for="highlightColor">ハイライトの色</label>
            <input
              type="color"
              id="highlightColor"
              name="highlightColor"
              class="color-input"
            />
            <p class="description">
              日付のハイライト表示に使用する色を選択します
            </p>
          </div>

          <div class="setting-item">
            <label for="includeURL">
              <input type="checkbox" id="includeURL" name="includeURL" />
              イベントにページURLを含める
            </label>
            <p class="description">
              カレンダーイベントの説明にページのURLを自動追加します
            </p>
          </div>
        </section>

        <!-- イベント設定 -->
        <section class="setting-section">
          <h2>イベント設定</h2>

          <div class="setting-item">
            <label for="defaultDuration">デフォルト時間（分）</label>
            <input
              type="number"
              id="defaultDuration"
              name="defaultDuration"
              min="15"
              max="1440"
              step="15"
              class="number-input"
            />
            <p class="description">
              時刻が指定されていない場合のイベント継続時間
            </p>
          </div>

          <div class="setting-item">
            <label for="defaultCalendar">追加先カレンダー</label>
            <select
              id="defaultCalendar"
              name="defaultCalendar"
              class="select-input"
            >
              <option value="primary">プライマリカレンダー</option>
            </select>
            <p class="description">イベントを追加するGoogleカレンダーを選択</p>
          </div>

          <div class="setting-item">
            <label for="timezone">タイムゾーン</label>
            <select id="timezone" name="timezone" class="select-input">
              <option value="Asia/Tokyo">日本標準時 (JST)</option>
              <option value="UTC">協定世界時 (UTC)</option>
              <option value="America/New_York">東部標準時 (EST)</option>
              <option value="America/Los_Angeles">太平洋標準時 (PST)</option>
              <option value="Europe/London">グリニッジ標準時 (GMT)</option>
              <option value="Europe/Paris">中央ヨーロッパ時間 (CET)</option>
              <option value="Asia/Shanghai">中国標準時 (CST)</option>
              <option value="Asia/Seoul">韓国標準時 (KST)</option>
              <option value="Australia/Sydney">
                オーストラリア東部標準時 (AEST)
              </option>
            </select>
            <p class="description">日付・時刻の解釈に使用するタイムゾーン</p>
          </div>
        </section>

        <!-- 日付形式設定 -->
        <section class="setting-section">
          <h2>日付形式設定</h2>

          <div class="setting-item">
            <label>優先する日付形式（上から順に適用）</label>
            <div class="sortable-list" id="dateFormatsContainer">
              <!-- JavaScriptで動的生成 -->
            </div>
            <p class="description">
              日付を検出する際の優先順位を設定します。ドラッグで並び替えできます。
            </p>
          </div>
        </section>

        <!-- サイト固有設定 -->
        <section class="setting-section">
          <h2>サイト固有設定</h2>

          <div class="setting-item">
            <label for="rulesEnabled">
              <input type="checkbox" id="rulesEnabled" name="rulesEnabled" />
              サイト固有ルールを有効にする
            </label>
            <p class="description">
              特定のウェブサイトで専用の抽出ルールを使用します
            </p>
          </div>

          <!-- 略：サイトルール関連のHTML -->
        </section>

        <!-- ドメイン除外リスト -->
        <section class="setting-section">
          <h2>ドメイン除外リスト</h2>
          <p class="description">
            ChronoClipを動作させないドメインやURLパターンを指定できます。
            サイトルールよりもシンプルに、特定のサイトで拡張機能を無効化できます。
          </p>

          <div class="setting-item">
            <label>除外パターン一覧</label>
            <div id="excludedDomainsList" class="excluded-domains-list">
              <!-- JavaScriptで動的生成 -->
            </div>
          </div>

          <div class="setting-item">
            <label for="newExcludedDomain">新しいパターンを追加</label>
            <div class="input-with-button">
              <input
                type="text"
                id="newExcludedDomain"
                placeholder="例: example.com, *.google.com, facebook.com/ads/*"
              />
              <button
                type="button"
                id="addExcludedDomainBtn"
                class="secondary-btn"
              >
                追加
              </button>
            </div>
            <p class="description">
              <strong>パターンの種類：</strong><br />
              • <code>example.com</code> - 完全一致（そのドメインのみ）<br />
              • <code>*.example.com</code> - サブドメイン一括（すべてのサブドメイン）<br />
              • <code>example.com/admin/*</code> - URLパターン（特定のパスのみ）
            </p>
          </div>
        </section>

        <!-- デバッグ・監視設定 -->
        <section class="setting-section">
          <h2>デバッグ・監視設定</h2>

          <div class="setting-item">
            <label for="debugMode">
              <input type="checkbox" id="debugMode" name="debugMode" />
              デバッグモードを有効にする
            </label>
            <p class="description">
              詳細なログ出力とデバッグ情報を表示します。開発者向け機能です。
            </p>
          </div>

          <div class="setting-item">
            <label for="errorReportConsent">
              <input
                type="checkbox"
                id="errorReportConsent"
                name="errorReportConsent"
              />
              エラーレポート送信に同意する
            </label>
            <p class="description">
              エラー発生時に匿名の障害レポートを送信して、拡張機能の改善に協力します。
            </p>
          </div>

          <div class="setting-item debug-actions">
            <label>デバッグアクション</label>
            <div class="button-group debug-buttons">
              <button type="button" id="clearLogsBtn" class="secondary-btn">
                ログクリア
              </button>
              <button type="button" id="exportLogsBtn" class="secondary-btn">
                ログエクスポート
              </button>
              <button
                type="button"
                id="testErrorHandlingBtn"
                class="secondary-btn"
              >
                エラーハンドリングテスト
              </button>
              <button
                type="button"
                id="showSystemInfoBtn"
                class="secondary-btn"
              >
                システム情報表示
              </button>
            </div>
            <p class="description">
              開発とトラブルシューティングのためのデバッグアクション
            </p>
          </div>

          <!-- ログ表示エリア -->
          <div class="setting-item debug-logs hidden" id="debugLogsContainer">
            <label>最新のログ出力</label>
            <div class="debug-log-controls">
              <label for="logLevelFilter">ログレベル:</label>
              <select
                id="logLevelFilter"
                class="select-input"
                title="表示するログレベルを選択"
              >
                <option value="all">すべて</option>
                <option value="debug">DEBUG</option>
                <option value="info">INFO</option>
                <option value="warn">WARN</option>
                <option value="error">ERROR</option>
                <option value="fatal">FATAL</option>
              </select>
              <button type="button" id="refreshLogsBtn" class="secondary-btn">
                更新
              </button>
              <button type="button" id="hideLogsBtn" class="secondary-btn">
                非表示
              </button>
            </div>
            <div id="debugLogsOutput" class="debug-logs-output"></div>
          </div>

          <!-- システム情報表示エリア -->
          <div class="setting-item system-info hidden" id="systemInfoContainer">
            <label>システム情報</label>
            <button type="button" id="hideSystemInfoBtn" class="secondary-btn">
              非表示
            </button>
            <div id="systemInfoOutput" class="system-info-output"></div>
          </div>
        </section>

        <!-- サイトルール編集モーダル -->
        <div id="siteRuleModal" class="modal">
          <div class="modal-content site-rule-modal-content">
            <div class="modal-header">
              <h3 id="siteRuleModalTitle">サイトルールの編集</h3>
              <button type="button" class="modal-close" id="closeSiteRuleModal">
                &times;
              </button>
            </div>

            <div class="modal-body">
              <form id="siteRuleForm">
                <!-- 基本設定 -->
                <div class="rule-section">
                  <h4>基本設定</h4>
                  <div class="setting-item">
                    <label for="ruleDomain">ドメイン名</label>
                    <input
                      type="text"
                      id="ruleDomain"
                      name="domain"
                      placeholder="example.com"
                      required
                    />
                    <p class="field-description">ルールを適用するドメイン名</p>
                  </div>

                  <div class="setting-item">
                    <label>
                      <input type="checkbox" id="ruleEnabled" name="enabled" />
                      このルールを有効にする
                    </label>
                  </div>

                  <div class="setting-item">
                    <label>
                      <input
                        type="checkbox"
                        id="ruleInheritSubdomains"
                        name="inheritSubdomains"
                      />
                      サブドメインにも適用
                    </label>
                    <p class="field-description">
                      例：example.com の設定を sub.example.com にも適用
                    </p>
                  </div>
                </div>

                <!-- 日付検出設定 -->
                <div class="rule-section">
                  <h4>日付検出設定</h4>
                  <div class="setting-item">
                    <label for="ruleDateAnchor">日付要素セレクター</label>
                    <input
                      type="text"
                      id="ruleDateAnchor"
                      name="dateAnchor"
                      placeholder=".date, time[datetime], .published"
                    />
                    <p class="field-description">
                      日付を含む要素のCSSセレクター
                    </p>
                  </div>

                  <div class="setting-item">
                    <label for="ruleDateBlock">ブロック境界セレクター</label>
                    <input
                      type="text"
                      id="ruleDateBlock"
                      name="dateBlock"
                      placeholder="article, .card, .item"
                    />
                    <p class="field-description">
                      関連情報をまとめる単位となる要素
                    </p>
                  </div>
                </div>

                <!-- タイトル抽出設定 -->
                <div class="rule-section">
                  <h4>タイトル抽出設定</h4>
                  <div class="setting-item">
                    <label for="ruleTitleSelector">タイトルセレクター</label>
                    <input
                      type="text"
                      id="ruleTitleSelector"
                      name="titleSelector"
                      placeholder="h1, h2, .title, .headline"
                    />
                    <p class="field-description">
                      同じブロック内のタイトル要素セレクター
                    </p>
                  </div>

                  <div class="setting-item">
                    <label>
                      <input
                        type="checkbox"
                        id="ruleTitleFallback"
                        name="titleFallback"
                      />
                      見出しからのフォールバック
                    </label>
                    <p class="field-description">
                      ブロック内にタイトルがない場合、前の見出しを使用
                    </p>
                  </div>
                </div>

                <!-- 詳細抽出設定 -->
                <div class="rule-section">
                  <h4>詳細抽出設定</h4>
                  <div class="setting-item">
                    <label for="ruleDescSelectors"
                      >詳細セレクター（1行1個）</label
                    >
                    <textarea
                      id="ruleDescSelectors"
                      name="descSelectors"
                      placeholder="p&#10;.description&#10;.content"
                      rows="3"
                    ></textarea>
                    <p class="field-description">
                      詳細を抽出する要素のセレクター（改行区切り）
                    </p>
                  </div>

                  <div class="setting-item">
                    <label for="ruleMaxBlocks">最大ブロック数</label>
                    <input
                      type="number"
                      id="ruleMaxBlocks"
                      name="maxBlocks"
                      min="1"
                      max="10"
                      value="3"
                    />
                    <p class="field-description">
                      詳細として収集する最大ブロック数
                    </p>
                  </div>

                  <div class="setting-item">
                    <label for="ruleIncludeURL">URL含有設定</label>
                    <select id="ruleIncludeURL" name="includeURL">
                      <option value="inherit">グローバル設定に従う</option>
                      <option value="true">URLを含める</option>
                      <option value="false">URLを含めない</option>
                    </select>
                  </div>
                </div>

                <!-- 場所・時間設定（折りたたみ） -->
                <div class="rule-section collapsible">
                  <h4
                    class="collapsible-header"
                    data-target="locationTimeSection"
                  >
                    場所・時間設定（オプション）
                    <span class="collapsible-icon">▼</span>
                  </h4>
                  <div class="collapsible-content" id="locationTimeSection">
                    <div class="setting-item">
                      <label for="ruleLocationSelector">場所セレクター</label>
                      <input
                        type="text"
                        id="ruleLocationSelector"
                        name="locationSelector"
                        placeholder=".venue, .location, [itemprop=location]"
                      />
                    </div>

                    <div class="setting-item">
                      <label for="ruleTimeStart">開始時刻セレクター</label>
                      <input
                        type="text"
                        id="ruleTimeStart"
                        name="timeStart"
                        placeholder=".start-time, .time-start"
                      />
                    </div>

                    <div class="setting-item">
                      <label for="ruleTimeEnd">終了時刻セレクター</label>
                      <input
                        type="text"
                        id="ruleTimeEnd"
                        name="timeEnd"
                        placeholder=".end-time, .time-end"
                      />
                    </div>

                    <div class="setting-item">
                      <label>
                        <input
                          type="checkbox"
                          id="rulePreferDateTime"
                          name="preferDateTime"
                        />
                        datetime属性を優先
                      </label>
                    </div>
                  </div>
                </div>

                <!-- フィルター設定（折りたたみ） -->
                <div class="rule-section collapsible">
                  <h4 class="collapsible-header" data-target="filterSection">
                    フィルター設定（オプション）
                    <span class="collapsible-icon">▼</span>
                  </h4>
                  <div class="collapsible-content" id="filterSection">
                    <div class="setting-item">
                      <label for="ruleRemoveSelectors"
                        >ノイズ除去セレクター（1行1個）</label
                      >
                      <textarea
                        id="ruleRemoveSelectors"
                        name="removeSelectors"
                        placeholder=".ad&#10;.advertisement&#10;.sidebar"
                        rows="3"
                      ></textarea>
                      <p class="field-description">
                        抽出前に除去する要素のセレクター
                      </p>
                    </div>

                    <div class="setting-item">
                      <label for="ruleStopwords"
                        >ストップワード（1行1個）</label
                      >
                      <textarea
                        id="ruleStopwords"
                        name="stopwords"
                        placeholder="advertisement&#10;sponsored&#10;PR"
                        rows="3"
                      ></textarea>
                      <p class="field-description">
                        このサイト特有のノイズとなる単語
                      </p>
                    </div>
                  </div>
                </div>

                <!-- 高度な設定（折りたたみ） -->
                <div class="rule-section collapsible">
                  <h4 class="collapsible-header" data-target="advancedSection">
                    高度な設定（オプション）
                    <span class="collapsible-icon">▼</span>
                  </h4>
                  <div class="collapsible-content" id="advancedSection">
                    <div class="setting-item">
                      <label for="ruleCustomJoiner">カスタム結合文字</label>
                      <input
                        type="text"
                        id="ruleCustomJoiner"
                        name="customJoiner"
                        placeholder=" / "
                      />
                      <p class="field-description">
                        複数の詳細ブロックを結合する文字
                      </p>
                    </div>

                    <div class="setting-item">
                      <label>
                        <input
                          type="checkbox"
                          id="ruleTrimBrackets"
                          name="trimBrackets"
                        />
                        括弧の圧縮
                      </label>
                      <p class="field-description">日本語の括弧表記を圧縮</p>
                    </div>
                  </div>
                </div>
              </form>
            </div>

            <div class="modal-footer">
              <button type="button" id="testSiteRuleBtn" class="secondary-btn">
                テスト実行
              </button>
              <button type="button" id="saveSiteRuleBtn" class="primary-btn">
                保存
              </button>
              <button
                type="button"
                id="deleteSiteRuleBtn"
                class="danger-btn hidden"
              >
                削除
              </button>
            </div>
          </div>
        </div>

        <!-- アクションボタン -->
        <section class="action-section">
          <div class="button-group">
            <button type="submit" id="saveBtn" class="primary-btn">
              設定を保存
            </button>
            <button type="button" id="resetBtn" class="secondary-btn">
              デフォルトに戻す
            </button>
          </div>
        </section>
      </form>

      <!-- トースト通知エリア -->
      <div id="toastContainer" class="toast-container"></div>

      <!-- 確認ダイアログ -->
      <div id="confirmModal" class="modal">
        <div class="modal-content">
          <h3 id="confirmTitle">確認</h3>
          <p id="confirmMessage">この操作を実行しますか？</p>
          <div class="modal-buttons">
            <button id="confirmOk" class="primary-btn">OK</button>
            <button id="confirmCancel" class="secondary-btn">キャンセル</button>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <p>ChronoClip v1.0 - ウェブページの日付をGoogleカレンダーに簡単追加</p>
      <div class="test-button-container">
        <button type="button" id="openTestPageBtn" class="test-button">
          📊 設定システムのテストページを開く
        </button>
      </div>
    </footer>

    <!-- スクリプト読み込み -->
    <script src="../../shared/logger.js"></script>
    <script src="../../shared/error-handler.js"></script>
    <script src="../../shared/settings.js"></script>
    <script src="../../shared/site-rule-manager.js"></script>
    <script src="../../shared/extractors/base-extractor.js"></script>
    <script src="../../shared/extractors/eventbrite-extractor.js"></script>
    <script src="../../shared/extractors/amazon-extractor.js"></script>
    <script src="../../shared/extractors/general-extractor.js"></script>
    <script src="../../shared/extractors/extractor-factory.js"></script>
    <script src="options.js"></script>
  </body>
</html>
