<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChronoClip 統合モジュールテスト</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      .test-section {
        border: 1px solid #ddd;
        margin: 20px 0;
        padding: 15px;
        border-radius: 5px;
      }
      .test-section h3 {
        margin-top: 0;
        color: #333;
      }
      .site-pattern {
        background-color: #f9f9f9;
        padding: 10px;
        margin: 10px 0;
        border-left: 4px solid #007cba;
      }
      .results {
        background-color: #f0f8ff;
        padding: 10px;
        margin: 10px 0;
        border-radius: 3px;
        font-family: monospace;
        white-space: pre-wrap;
      }
      button {
        background-color: #007cba;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 3px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #005a87;
      }
      .error {
        color: red;
        background-color: #ffe6e6;
        padding: 10px;
        border-radius: 3px;
      }
      .success {
        color: green;
        background-color: #e6ffe6;
        padding: 10px;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <h1>ChronoClip 統合モジュールテスト</h1>

    <div class="test-section">
      <h3>1. モジュール読み込みテスト</h3>
      <button onclick="testModuleLoading()">モジュール読み込み確認</button>
      <div id="module-results" class="results"></div>
    </div>

    <div class="test-section">
      <h3>2. サイトパターンテスト</h3>
      <div class="site-pattern">
        <strong>EventBrite風イベント:</strong>
        <h2 class="event-title">夏祭りコンサート 2025</h2>
        <div class="event-details__data">
          2025年8月15日（金）18:00開場 19:00開演
        </div>
        <div class="event-description">
          夏の夜空の下で楽しむクラシックコンサート。有名アーティストによる特別演奏をお楽しみください。
        </div>
        <div class="event-card__price">一般: ¥3,500 学生: ¥2,000</div>
        <div class="venue-info">会場: 東京国際フォーラム</div>
      </div>

      <div class="site-pattern">
        <strong>Amazon風商品:</strong>
        <h1 id="productTitle">高性能ワイヤレスイヤホン</h1>
        <div id="availability">
          <span class="a-color-success">お届け予定日: 8月30日（水）</span>
        </div>
        <div class="a-unordered-list">
          <span class="a-list-item">ノイズキャンセリング機能搭載</span>
          <span class="a-list-item">最大24時間の連続再生</span>
        </div>
        <span class="a-price-whole">¥12,800</span>
      </div>

      <button onclick="testSitePatterns()">サイトパターン抽出テスト</button>
      <div id="site-pattern-results" class="results"></div>
    </div>

    <div class="test-section">
      <h3>3. 選択範囲抽出テスト</h3>
      <div>
        <p>以下のテキストを選択してボタンをクリックしてください：</p>
        <p>
          <strong>重要なお知らせ:</strong>
          2025年9月15日（月）14:30からプロジェクト会議を開催します。会議室Aにて、新商品の企画について議論する予定です。参加必須です。
        </p>
        <p>締切は<strong>2025年10月31日</strong>となります。</p>
      </div>
      <button onclick="testSelectionExtraction()">選択範囲抽出テスト</button>
      <div id="selection-results" class="results"></div>
    </div>

    <div class="test-section">
      <h3>4. ページスキャンテスト</h3>
      <button onclick="testPageScan()">ページ全体スキャン</button>
      <div id="page-scan-results" class="results"></div>
    </div>

    <div class="test-section">
      <h3>5. カスタムパターン追加テスト</h3>
      <button onclick="testCustomPattern()">カスタムパターン追加</button>
      <div id="custom-pattern-results" class="results"></div>
    </div>

    <!-- 必要なライブラリの読み込み -->
    <script src="../config/constants.js"></script>
    <script src="../config/site-patterns.js"></script>
    <script src="../lib/date-utils.js"></script>
    <script src="../lib/chrono.min.js"></script>
    <script src="../lib/date-parser.js"></script>
    <script src="../content/event-detector.js"></script>
    <script src="../content/extractor-api.js"></script>
    <script src="../content/selection.js"></script>

    <script>
      // テスト関数群
      function testModuleLoading() {
        const resultDiv = document.getElementById("module-results");
        let results = "モジュール読み込み状況:\n";

        const modules = [
          { name: "ChronoClipDateParser", obj: window.ChronoClipDateParser },
          {
            name: "ChronoClipEventDetector",
            obj: window.ChronoClipEventDetector,
          },
          { name: "ChronoClipExtractor", obj: window.ChronoClipExtractor },
          {
            name: "ChronoClipSitePatterns",
            obj: window.ChronoClipSitePatterns,
          },
          { name: "chrono", obj: window.chrono },
        ];

        modules.forEach((module) => {
          if (module.obj) {
            results += `✅ ${module.name}: 読み込み済み\n`;
          } else {
            results += `❌ ${module.name}: 読み込みエラー\n`;
          }
        });

        // EventDetectorの初期化状況
        if (window.ChronoClipEventDetector) {
          results += `\nEventDetector初期化: ${
            window.ChronoClipEventDetector.initialized ? "✅" : "❌"
          }\n`;
          results += `登録済みサイトパターン数: ${window.ChronoClipEventDetector.sitePatterns.size}\n`;
          results += `登録済み抽出戦略数: ${window.ChronoClipEventDetector.extractionStrategies.size}\n`;
        }

        resultDiv.textContent = results;
      }

      async function testSitePatterns() {
        const resultDiv = document.getElementById("site-pattern-results");

        if (!window.ChronoClipExtractor) {
          resultDiv.textContent = "❌ ExtractorAPIが利用できません";
          return;
        }

        try {
          let results = "サイトパターンテスト結果:\n\n";

          // EventBrite風要素のテスト
          const eventTitle = document.querySelector(".event-title");
          if (eventTitle) {
            const eventResult =
              await window.ChronoClipExtractor.extractFromElement(eventTitle);
            results += "--- EventBrite風要素 ---\n";
            results += `日付情報: ${eventResult.dateInfo ? "あり" : "なし"}\n`;
            results += `タイトル: ${eventResult.title || "なし"}\n`;
            results += `詳細: ${eventResult.description ? "あり" : "なし"}\n`;
            results += `信頼度: ${eventResult.metadata?.confidence || 0}\n`;
            results += `使用戦略: ${
              eventResult.metadata?.strategies?.join(", ") || "なし"
            }\n\n`;
          }

          // Amazon風要素のテスト
          const productTitle = document.querySelector("#productTitle");
          if (productTitle) {
            const productResult =
              await window.ChronoClipExtractor.extractFromElement(productTitle);
            results += "--- Amazon風要素 ---\n";
            results += `日付情報: ${
              productResult.dateInfo ? "あり" : "なし"
            }\n`;
            results += `タイトル: ${productResult.title || "なし"}\n`;
            results += `詳細: ${productResult.description ? "あり" : "なし"}\n`;
            results += `信頼度: ${productResult.metadata?.confidence || 0}\n`;
            results += `使用戦略: ${
              productResult.metadata?.strategies?.join(", ") || "なし"
            }\n\n`;
          }

          resultDiv.textContent = results;
        } catch (error) {
          resultDiv.textContent = `❌ エラー: ${error.message}`;
        }
      }

      async function testSelectionExtraction() {
        const resultDiv = document.getElementById("selection-results");

        const selection = window.getSelection();
        if (selection.rangeCount === 0) {
          resultDiv.textContent = "❌ テキストを選択してください";
          return;
        }

        try {
          const range = selection.getRangeAt(0);
          const selectionInfo = {
            text: selection.toString(),
            element:
              range.commonAncestorContainer.nodeType === Node.TEXT_NODE
                ? range.commonAncestorContainer.parentElement
                : range.commonAncestorContainer,
          };

          const contextInfo = {
            heading: { text: document.querySelector("h3")?.textContent || "" },
            paragraphs: [{ text: selectionInfo.element.textContent }],
            parent: selectionInfo.element.parentElement,
          };

          const pageInfo = {
            url: window.location.href,
            title: document.title,
            domain: window.location.hostname,
          };

          // 新しいAPIを使用
          if (window.ChronoClipExtractor) {
            const result =
              await window.ChronoClipExtractor.extractFromSelection(
                selectionInfo,
                contextInfo,
                pageInfo
              );

            let results = "選択範囲抽出結果:\n\n";
            results += `選択テキスト: "${selectionInfo.text}"\n\n`;
            results += `日付情報: ${result.dateInfo ? "あり" : "なし"}\n`;
            if (result.dateInfo) {
              results += `  種類: ${result.dateInfo.type}\n`;
              results += `  開始: ${
                result.dateInfo.start.date || result.dateInfo.start.dateTime
              }\n`;
              results += `  信頼度: ${result.dateInfo.confidence}\n`;
            }
            results += `タイトル: ${result.title || "なし"}\n`;
            results += `詳細: ${
              result.description
                ? "あり (長さ: " + result.description.length + ")"
                : "なし"
            }\n`;
            results += `全体信頼度: ${result.metadata?.confidence || 0}\n`;
            results += `使用戦略: ${
              result.metadata?.strategies?.join(", ") || "なし"
            }\n`;

            resultDiv.textContent = results;
          } else {
            resultDiv.textContent = "❌ ExtractorAPIが利用できません";
          }
        } catch (error) {
          resultDiv.textContent = `❌ エラー: ${error.message}`;
        }
      }

      async function testPageScan() {
        const resultDiv = document.getElementById("page-scan-results");

        if (!window.ChronoClipExtractor) {
          resultDiv.textContent = "❌ ExtractorAPIが利用できません";
          return;
        }

        try {
          resultDiv.textContent = "ページスキャン中...";

          const results = await window.ChronoClipExtractor.extractFromPage({
            maxResults: 10,
          });

          let output = `ページスキャン結果: ${results.length}件\n\n`;

          results.forEach((result, index) => {
            output += `--- 結果 ${index + 1} ---\n`;
            output += `要素: ${result.element.tagName}\n`;
            output += `日付: ${result.dateInfo ? "あり" : "なし"}\n`;
            if (result.dateInfo) {
              output += `  ${
                result.dateInfo.start.date || result.dateInfo.start.dateTime
              }\n`;
            }
            output += `タイトル: ${result.title || "なし"}\n`;
            output += `信頼度: ${result.metadata?.confidence || 0}\n\n`;
          });

          resultDiv.textContent = output;
        } catch (error) {
          resultDiv.textContent = `❌ エラー: ${error.message}`;
        }
      }

      function testCustomPattern() {
        const resultDiv = document.getElementById("custom-pattern-results");

        try {
          // カスタムパターンの追加テスト
          const customPattern = {
            domains: ["test.example.com"],
            selectors: {
              title: [".custom-title"],
              date: [".custom-date"],
              description: [".custom-description"],
            },
            dateFormats: ["YYYY年MM月DD日"],
            priority: 20,
            extraction: {
              dateStrategy: "site-specific",
              titleStrategy: "site-specific",
              descriptionStrategy: "site-specific",
            },
          };

          if (window.addCustomSitePattern) {
            window.addCustomSitePattern("custom-test", customPattern);

            let results = "カスタムパターン追加テスト:\n\n";
            results += '✅ カスタムパターン "custom-test" を追加しました\n';
            results += `対象ドメイン: ${customPattern.domains.join(", ")}\n`;
            results += `優先度: ${customPattern.priority}\n`;

            // 登録確認
            if (
              window.ChronoClipSitePatterns &&
              window.ChronoClipSitePatterns["custom-test"]
            ) {
              results += "✅ パターンの登録を確認しました\n";
            } else {
              results += "❌ パターンの登録に失敗しました\n";
            }

            resultDiv.textContent = results;
          } else {
            resultDiv.textContent =
              "❌ addCustomSitePattern関数が利用できません";
          }
        } catch (error) {
          resultDiv.textContent = `❌ エラー: ${error.message}`;
        }
      }

      // ページ読み込み後の初期化
      window.addEventListener("load", () => {
        setTimeout(() => {
          testModuleLoading();
        }, 1000);
      });
    </script>
  </body>
</html>
