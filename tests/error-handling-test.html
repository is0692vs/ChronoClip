<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChronoClip エラーハンドリングテスト</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      .test-section {
        border: 1px solid #ddd;
        margin: 20px 0;
        padding: 15px;
        border-radius: 5px;
        background-color: #f9f9f9;
      }
      .test-section h3 {
        margin-top: 0;
        color: #333;
      }
      .date-text {
        background-color: #e7f3ff;
        padding: 5px;
        border-left: 4px solid #007cba;
        margin: 10px 0;
      }
      .console-output {
        background-color: #f0f0f0;
        padding: 10px;
        margin: 10px 0;
        border-radius: 3px;
        font-family: monospace;
        max-height: 200px;
        overflow-y: auto;
      }
      button {
        background-color: #007cba;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #005a8b;
      }
    </style>
  </head>
  <body>
    <h1>ChronoClip エラーハンドリングテスト</h1>

    <div class="test-section">
      <h3>📅 基本的な日付検出テスト</h3>
      <p>
        以下の日付をクリックしてポップアップが表示されることを確認してください：
      </p>
      <div class="date-text">2024年12月25日のクリスマスイベント</div>
      <div class="date-text">明日の午後2時からミーティング</div>
      <div class="date-text">来週金曜日の懇親会</div>
    </div>

    <div class="test-section">
      <h3>🔍 ログ・エラーハンドリング確認</h3>
      <p>以下のボタンを押してコンソールでログ出力を確認してください：</p>
      <button onclick="testLogger()">Logger動作テスト</button>
      <button onclick="testErrorHandler()">ErrorHandler動作テスト</button>
      <button onclick="checkGlobalObjects()">グローバルオブジェクト確認</button>
      <button onclick="clearConsole()">コンソールクリア</button>

      <div class="console-output" id="console-output">
        <div style="color: #666">ここにコンソール出力の一部が表示されます</div>
      </div>
    </div>

    <div class="test-section">
      <h3>⚠️ エラー挙動テスト</h3>
      <p>意図的にエラーを発生させて、適切にハンドリングされることを確認：</p>
      <button onclick="simulateExtractionError()">
        抽出エラーシミュレーション
      </button>
      <button onclick="simulateUIError()">UI表示エラーシミュレーション</button>
      <button onclick="simulateSettingsError()">
        設定読み込みエラーシミュレーション
      </button>
    </div>

    <div class="test-section">
      <h3>✅ 期待される動作</h3>
      <ul>
        <li>日付テキストをクリック → ポップアップ表示</li>
        <li>addボタン押下 → 何も起こらない（仕様通り）</li>
        <li>エラー発生時 → 適切なログ出力＋ユーザー通知</li>
        <li>処理継続 → エラー後もデフォルト機能は動作</li>
      </ul>
    </div>

    <script>
      let logOutput = [];

      // コンソール出力をキャプチャ
      const originalLog = console.log;
      const originalWarn = console.warn;
      const originalError = console.error;

      function addToOutput(type, message) {
        const timestamp = new Date().toLocaleTimeString();
        logOutput.push(`[${timestamp}] ${type}: ${message}`);
        updateConsoleOutput();
      }

      console.log = function (...args) {
        originalLog.apply(console, args);
        addToOutput("LOG", args.join(" "));
      };

      console.warn = function (...args) {
        originalWarn.apply(console, args);
        addToOutput("WARN", args.join(" "));
      };

      console.error = function (...args) {
        originalError.apply(console, args);
        addToOutput("ERROR", args.join(" "));
      };

      function updateConsoleOutput() {
        const output = document.getElementById("console-output");
        output.innerHTML = logOutput
          .slice(-10)
          .map(
            (log) =>
              `<div style="color: ${
                log.includes("ERROR")
                  ? "red"
                  : log.includes("WARN")
                  ? "orange"
                  : "blue"
              }">${log}</div>`
          )
          .join("");
      }

      function testLogger() {
        console.log("🧪 Logger動作テスト開始");
        if (window.ChronoClipLogger) {
          const logger = new window.ChronoClipLogger();
          logger.info("テスト情報メッセージ", { test: true });
          logger.warn("テスト警告メッセージ", { warning: true });
          logger.debug("テストデバッグメッセージ", { debug: true });
          console.log("✅ Logger動作正常");
        } else {
          console.error("❌ ChronoClipLogger が見つかりません");
        }
      }

      function testErrorHandler() {
        console.log("🧪 ErrorHandler動作テスト開始");
        if (window.ChronoClipErrorHandler) {
          const errorHandler = new window.ChronoClipErrorHandler();
          const testError = new Error("テスト用エラー");
          const handled = errorHandler.handleError(testError, {
            type: "test",
            phase: "unit_test",
          });
          console.log("✅ ErrorHandler動作正常:", handled);
        } else {
          console.error("❌ ChronoClipErrorHandler が見つかりません");
        }
      }

      function checkGlobalObjects() {
        console.log("🧪 グローバルオブジェクト確認");
        const objects = [
          "ChronoClipLogger",
          "ChronoClipErrorHandler",
          "ChronoClipSettings",
          "ChronoClipExtractorFactory",
          "ChronoClipExtractor",
        ];

        objects.forEach((obj) => {
          if (window[obj]) {
            console.log(`✅ ${obj} は利用可能`);
          } else {
            console.error(`❌ ${obj} が見つかりません`);
          }
        });
      }

      function simulateExtractionError() {
        console.log("🧪 抽出エラーシミュレーション");
        try {
          // 意図的に無効な抽出を実行
          if (window.ChronoClipExtractor) {
            window.ChronoClipExtractor.extractEventContext(null, null);
          }
        } catch (error) {
          console.log(
            "✅ 抽出エラーが適切にキャッチされました:",
            error.message
          );
        }
      }

      function simulateUIError() {
        console.log("🧪 UI表示エラーシミュレーション");
        try {
          // 存在しない要素にアクセス
          document.getElementById("non-existent-element").click();
        } catch (error) {
          console.log("✅ UIエラーが適切にキャッチされました:", error.message);
        }
      }

      function simulateSettingsError() {
        console.log("🧪 設定読み込みエラーシミュレーション");
        if (window.ChronoClipSettings) {
          // 設定へのアクセステスト
          try {
            const settings = window.ChronoClipSettings.getDefaultSettings();
            console.log("✅ 設定アクセス正常:", settings);
          } catch (error) {
            console.log(
              "✅ 設定エラーが適切にキャッチされました:",
              error.message
            );
          }
        }
      }

      function clearConsole() {
        logOutput = [];
        updateConsoleOutput();
        console.clear();
      }

      // ページ読み込み完了時の初期チェック
      window.addEventListener("load", function () {
        setTimeout(() => {
          console.log(
            "🚀 ChronoClip エラーハンドリングテストページ読み込み完了"
          );
          checkGlobalObjects();
        }, 1000);
      });
    </script>
  </body>
</html>
