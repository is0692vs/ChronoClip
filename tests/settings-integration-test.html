<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChronoClip 設定システム統合テスト</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      .test-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f9f9f9;
      }
      .test-title {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
      }
      .test-result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .json-display {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      .test-controls {
        margin-bottom: 20px;
        padding: 15px;
        background: #e9ecef;
        border-radius: 8px;
      }
      .test-input {
        margin: 10px 0;
      }
      .test-input label {
        display: inline-block;
        width: 150px;
        font-weight: bold;
      }
      .test-input input,
      .test-input select {
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <h1>🗓️ ChronoClip 設定システム統合テスト</h1>
    <p>
      このページでは設定の読み込み、保存、バリデーション、ブロードキャスト、マイグレーションをテストできます。
    </p>

    <!-- テスト実行コントロール -->
    <div class="test-controls">
      <h3>テスト実行</h3>
      <button onclick="runAllTests()">全テスト実行</button>
      <button onclick="clearResults()">結果クリア</button>
      <button onclick="openOptionsPage()">設定ページを開く</button>
      <div class="test-input">
        <label>テスト用設定:</label>
        <button onclick="loadTestSettings()">テストデータ読み込み</button>
        <button onclick="resetToDefault()">デフォルトに戻す</button>
      </div>
    </div>

    <!-- 基本機能テスト -->
    <div class="test-section">
      <div class="test-title">1. 基本機能テスト</div>
      <button onclick="testBasicLoadSave()">実行</button>
      <div id="test-basic-result" class="test-result"></div>
    </div>

    <!-- バリデーションテスト -->
    <div class="test-section">
      <div class="test-title">2. バリデーションテスト</div>
      <button onclick="testValidation()">実行</button>
      <div id="test-validation-result" class="test-result"></div>
    </div>

    <!-- マイグレーションテスト -->
    <div class="test-section">
      <div class="test-title">3. マイグレーションテスト</div>
      <button onclick="testMigration()">実行</button>
      <div id="test-migration-result" class="test-result"></div>
    </div>

    <!-- ブロードキャストテスト -->
    <div class="test-section">
      <div class="test-title">4. ブロードキャストテスト</div>
      <button onclick="testBroadcast()">実行</button>
      <div id="test-broadcast-result" class="test-result"></div>
    </div>

    <!-- リアルタイム設定監視 -->
    <div class="test-section">
      <div class="test-title">5. リアルタイム設定監視</div>
      <button onclick="startSettingsWatch()">監視開始</button>
      <button onclick="stopSettingsWatch()">監視停止</button>
      <div id="test-watch-result" class="test-result"></div>
    </div>

    <!-- 現在の設定表示 -->
    <div class="test-section">
      <div class="test-title">現在の設定</div>
      <button onclick="displayCurrentSettings()">更新</button>
      <div id="current-settings" class="json-display"></div>
    </div>

    <!-- スクリプト読み込み -->
    <script src="../lib/settings.js"></script>
    <script>
      let watchListener = null;
      let testResults = {};
      let isExtensionContext = false;

      // 拡張機能のコンテキストかどうかをチェック
      function checkExtensionContext() {
        isExtensionContext = !!(
          typeof chrome !== "undefined" &&
          chrome.storage &&
          chrome.storage.sync
        );
        if (!isExtensionContext) {
          // 警告メッセージを表示
          const warningDiv = document.createElement("div");
          warningDiv.style.cssText = `
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-weight: bold;
          `;
          warningDiv.innerHTML = `
            ⚠️ <strong>警告:</strong> このページはChrome拡張機能のコンテキストで実行されていません。<br>
            正しくテストするには、以下のいずれかの方法を使用してください：<br>
            1. 拡張機能を読み込んで、chrome-extension:// URLからアクセス<br>
            2. オプションページから「テストページを開く」をクリック<br>
            3. ブラウザで拡張機能として読み込み後、アドレスバーに: <code>chrome-extension://&lt;extension-id&gt;/tests/settings-integration-test.html</code>
          `;
          document.body.insertBefore(warningDiv, document.body.firstChild);
        }
        return isExtensionContext;
      }

      // テスト結果を表示する関数
      function displayResult(testId, result, isSuccess = true) {
        const element = document.getElementById(testId);
        element.className = `test-result ${isSuccess ? "success" : "error"}`;
        element.textContent = result;
        testResults[testId] = { result, isSuccess };
      }

      function displayInfo(testId, info) {
        const element = document.getElementById(testId);
        element.className = "test-result info";
        element.textContent = info;
      }

      // 1. 基本機能テスト
      async function testBasicLoadSave() {
        if (!isExtensionContext) {
          displayResult(
            "test-basic-result",
            "スキップ (Chrome APIが利用できません)",
            false
          );
          return;
        }

        try {
          displayInfo("test-basic-result", "基本機能テスト実行中...");

          // 設定読み込み
          const settings = await window.ChronoClipSettings.getSettings();
          console.log("Loaded settings:", settings);

          // 設定保存テスト
          const testPatch = { autoDetect: !settings.autoDetect };
          const updatedSettings = await window.ChronoClipSettings.setSettings(
            testPatch
          );

          // 元に戻す
          await window.ChronoClipSettings.setSettings({
            autoDetect: settings.autoDetect,
          });

          displayResult(
            "test-basic-result",
            `✅ 基本機能テスト成功: 設定の読み込み・保存が正常に動作`,
            true
          );
        } catch (error) {
          displayResult(
            "test-basic-result",
            `❌ 基本機能テストエラー: ${error.message}`,
            false
          );
        }
      }

      // 2. バリデーションテスト
      async function testValidation() {
        if (!isExtensionContext) {
          displayResult(
            "test-validation-result",
            "スキップ (Chrome APIが利用できません)",
            false
          );
          return;
        }

        try {
          displayInfo(
            "test-validation-result",
            "バリデーションテスト実行中..."
          );

          const validationTests = [
            // 無効なdefaultDuration
            {
              defaultDuration: -1,
              expectError: true,
              name: "negative duration",
            },
            {
              defaultDuration: 2000,
              expectError: true,
              name: "too large duration",
            },
            // 無効なdateFormats
            { dateFormats: [], expectError: true, name: "empty dateFormats" },
            {
              dateFormats: ["INVALID"],
              expectError: true,
              name: "invalid dateFormat",
            },
            // 無効なtimezone
            { timezone: "", expectError: true, name: "empty timezone" },
            // 有効な設定
            {
              defaultDuration: 120,
              dateFormats: ["JP", "US"],
              timezone: "Asia/Tokyo",
              expectError: false,
              name: "valid settings",
            },
          ];

          let passCount = 0;
          let totalCount = validationTests.length;

          for (const test of validationTests) {
            try {
              await window.ChronoClipSettings.setSettings(test);
              if (test.expectError) {
                console.warn(`Expected error for ${test.name}, but succeeded`);
              } else {
                passCount++;
              }
            } catch (error) {
              if (test.expectError) {
                passCount++;
              } else {
                console.error(`Unexpected error for ${test.name}:`, error);
              }
            }
          }

          displayResult(
            "test-validation-result",
            `✅ バリデーションテスト: ${passCount}/${totalCount} テストが期待通りに動作`,
            passCount === totalCount
          );
        } catch (error) {
          displayResult(
            "test-validation-result",
            `❌ バリデーションテストエラー: ${error.message}`,
            false
          );
        }
      }

      // 3. マイグレーションテスト
      async function testMigration() {
        if (!isExtensionContext) {
          displayResult(
            "test-migration-result",
            "スキップ (Chrome APIが利用できません)",
            false
          );
          return;
        }

        try {
          displayInfo(
            "test-migration-result",
            "マイグレーションテスト実行中..."
          );

          // 古いバージョンの設定をシミュレート
          const oldSettings = { autoDetect: true, version: 0 };

          // Chrome Storage に直接古い設定を保存
          await chrome.storage.sync.set({ chronoClipSettings: oldSettings });

          // 設定を読み込み（マイグレーションが実行される）
          const migratedSettings =
            await window.ChronoClipSettings.getSettings();

          if (
            migratedSettings.version === 1 &&
            migratedSettings.highlightDates !== undefined
          ) {
            displayResult(
              "test-migration-result",
              `✅ マイグレーションテスト成功: v0 → v1 に正常にマイグレーション`,
              true
            );
          } else {
            displayResult(
              "test-migration-result",
              `❌ マイグレーション失敗: 期待した結果になりませんでした`,
              false
            );
          }
        } catch (error) {
          displayResult(
            "test-migration-result",
            `❌ マイグレーションテストエラー: ${error.message}`,
            false
          );
        }
      }

      // 4. ブロードキャストテスト
      async function testBroadcast() {
        if (!isExtensionContext) {
          displayResult(
            "test-broadcast-result",
            "スキップ (Chrome APIが利用できません)",
            false
          );
          return;
        }

        try {
          displayInfo(
            "test-broadcast-result",
            "ブロードキャストテスト実行中..."
          );

          let broadcastReceived = false;
          let broadcastData = null;

          // 一時的なリスナーを登録
          const tempListener = (settings) => {
            broadcastReceived = true;
            broadcastData = settings;
          };

          window.ChronoClipSettings.onSettingsChanged(tempListener);

          // 設定変更（ブロードキャストをトリガー）
          await window.ChronoClipSettings.setSettings({ defaultDuration: 150 });

          // 少し待ってからチェック
          setTimeout(() => {
            window.ChronoClipSettings.removeSettingsListener(tempListener);

            if (
              broadcastReceived &&
              broadcastData &&
              broadcastData.defaultDuration === 150
            ) {
              displayResult(
                "test-broadcast-result",
                `✅ ブロードキャストテスト成功: 設定変更が正常に通知された`,
                true
              );
            } else {
              displayResult(
                "test-broadcast-result",
                `❌ ブロードキャスト失敗: 通知が受信されなかった`,
                false
              );
            }
          }, 200);
        } catch (error) {
          displayResult(
            "test-broadcast-result",
            `❌ ブロードキャストテストエラー: ${error.message}`,
            false
          );
        }
      }

      // 5. リアルタイム設定監視
      function startSettingsWatch() {
        if (watchListener) {
          stopSettingsWatch();
        }

        watchListener = (settings) => {
          const timestamp = new Date().toLocaleTimeString();
          const info = `[${timestamp}] 設定変更検出: autoDetect=${settings.autoDetect}, highlightDates=${settings.highlightDates}, defaultDuration=${settings.defaultDuration}分`;
          displayInfo("test-watch-result", info);
        };

        window.ChronoClipSettings.onSettingsChanged(watchListener);
        displayInfo(
          "test-watch-result",
          "⏱️ 設定変更の監視を開始しました（設定ページで変更してください）"
        );
      }

      function stopSettingsWatch() {
        if (watchListener) {
          window.ChronoClipSettings.removeSettingsListener(watchListener);
          watchListener = null;
          displayInfo("test-watch-result", "⏹️ 設定変更の監視を停止しました");
        }
      }

      // 現在の設定表示
      async function displayCurrentSettings() {
        if (!isExtensionContext) {
          document.getElementById("current-settings").textContent =
            "Chrome拡張機能のコンテキストで実行してください";
          return;
        }

        try {
          const settings = await window.ChronoClipSettings.getSettings();
          document.getElementById("current-settings").textContent =
            JSON.stringify(settings, null, 2);
        } catch (error) {
          document.getElementById(
            "current-settings"
          ).textContent = `エラー: ${error.message}`;
        }
      }

      // テストデータ読み込み
      async function loadTestSettings() {
        if (!isExtensionContext) {
          alert("Chrome拡張機能のコンテキストで実行してください");
          return;
        }

        try {
          const testSettings = {
            autoDetect: false,
            highlightDates: true,
            defaultDuration: 90,
            defaultCalendar: "test-calendar",
            timezone: "America/New_York",
            includeURL: false,
            dateFormats: ["US", "ISO"],
            rulesEnabled: true,
            siteRules: {
              "example.com": {
                enabled: true,
                selectors: [".event-date", ".schedule-time"],
              },
            },
          };

          await window.ChronoClipSettings.setSettings(testSettings);
          displayCurrentSettings();
          alert("テスト用設定を読み込みました");
        } catch (error) {
          alert(`テストデータ読み込みエラー: ${error.message}`);
        }
      }

      // デフォルトにリセット
      async function resetToDefault() {
        if (!isExtensionContext) {
          alert("Chrome拡張機能のコンテキストで実行してください");
          return;
        }

        try {
          await window.ChronoClipSettings.resetToDefault();
          displayCurrentSettings();
          alert("設定をデフォルトにリセットしました");
        } catch (error) {
          alert(`リセットエラー: ${error.message}`);
        }
      }

      // 設定ページを開く
      function openOptionsPage() {
        chrome.runtime.openOptionsPage();
      }

      // 全テスト実行
      async function runAllTests() {
        if (!checkExtensionContext()) {
          alert(
            "Chrome拡張機能のコンテキストで実行してください。\n\n拡張機能を読み込み後、chrome-extension:// URLからアクセスしてください。"
          );
          return;
        }

        clearResults();
        await testBasicLoadSave();
        await new Promise((resolve) => setTimeout(resolve, 500));
        await testValidation();
        await new Promise((resolve) => setTimeout(resolve, 500));
        await testMigration();
        await new Promise((resolve) => setTimeout(resolve, 500));
        await testBroadcast();

        displayCurrentSettings();
      }

      // 結果クリア
      function clearResults() {
        const resultElements = document.querySelectorAll(".test-result");
        resultElements.forEach((element) => {
          element.className = "test-result";
          element.textContent = "";
        });
        testResults = {};
      }

      // ページ読み込み時の初期化
      document.addEventListener("DOMContentLoaded", () => {
        // Chrome API利用可能性チェック
        checkExtensionContext();

        if (isExtensionContext) {
          displayCurrentSettings();
          console.log(
            "ChronoClip 設定システム統合テストページが読み込まれました (Chrome拡張機能コンテキスト)"
          );
        } else {
          console.warn(
            "ChronoClip 設定システム統合テストページが読み込まれました (通常のWebページコンテキスト - APIテストはスキップされます)"
          );
        }
      });
    </script>
  </body>
</html>
