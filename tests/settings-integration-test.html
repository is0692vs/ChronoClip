<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChronoClip è¨­å®šã‚·ã‚¹ãƒ†ãƒ çµ±åˆãƒ†ã‚¹ãƒˆ</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      .test-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f9f9f9;
      }
      .test-title {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
      }
      .test-result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .json-display {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      .test-controls {
        margin-bottom: 20px;
        padding: 15px;
        background: #e9ecef;
        border-radius: 8px;
      }
      .test-input {
        margin: 10px 0;
      }
      .test-input label {
        display: inline-block;
        width: 150px;
        font-weight: bold;
      }
      .test-input input,
      .test-input select {
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ—“ï¸ ChronoClip è¨­å®šã‚·ã‚¹ãƒ†ãƒ çµ±åˆãƒ†ã‚¹ãƒˆ</h1>
    <p>
      ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯è¨­å®šã®èª­ã¿è¾¼ã¿ã€ä¿å­˜ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚
    </p>

    <!-- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="test-controls">
      <h3>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h3>
      <button onclick="runAllTests()">å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
      <button onclick="clearResults()">çµæœã‚¯ãƒªã‚¢</button>
      <button onclick="openOptionsPage()">è¨­å®šãƒšãƒ¼ã‚¸ã‚’é–‹ã</button>
      <div class="test-input">
        <label>ãƒ†ã‚¹ãƒˆç”¨è¨­å®š:</label>
        <button onclick="loadTestSettings()">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</button>
        <button onclick="resetToDefault()">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
      </div>
    </div>

    <!-- åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ -->
    <div class="test-section">
      <div class="test-title">1. åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</div>
      <button onclick="testBasicLoadSave()">å®Ÿè¡Œ</button>
      <div id="test-basic-result" class="test-result"></div>
    </div>

    <!-- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ -->
    <div class="test-section">
      <div class="test-title">2. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ</div>
      <button onclick="testValidation()">å®Ÿè¡Œ</button>
      <div id="test-validation-result" class="test-result"></div>
    </div>

    <!-- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ -->
    <div class="test-section">
      <div class="test-title">3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ</div>
      <button onclick="testMigration()">å®Ÿè¡Œ</button>
      <div id="test-migration-result" class="test-result"></div>
    </div>

    <!-- ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ†ã‚¹ãƒˆ -->
    <div class="test-section">
      <div class="test-title">4. ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ†ã‚¹ãƒˆ</div>
      <button onclick="testBroadcast()">å®Ÿè¡Œ</button>
      <div id="test-broadcast-result" class="test-result"></div>
    </div>

    <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨­å®šç›£è¦– -->
    <div class="test-section">
      <div class="test-title">5. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨­å®šç›£è¦–</div>
      <button onclick="startSettingsWatch()">ç›£è¦–é–‹å§‹</button>
      <button onclick="stopSettingsWatch()">ç›£è¦–åœæ­¢</button>
      <div id="test-watch-result" class="test-result"></div>
    </div>

    <!-- ç¾åœ¨ã®è¨­å®šè¡¨ç¤º -->
    <div class="test-section">
      <div class="test-title">ç¾åœ¨ã®è¨­å®š</div>
      <button onclick="displayCurrentSettings()">æ›´æ–°</button>
      <div id="current-settings" class="json-display"></div>
    </div>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ -->
    <script src="../lib/settings.js"></script>
    <script>
      let watchListener = null;
      let testResults = {};
      let isExtensionContext = false;

      // æ‹¡å¼µæ©Ÿèƒ½ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
      function checkExtensionContext() {
        isExtensionContext = !!(
          typeof chrome !== "undefined" &&
          chrome.storage &&
          chrome.storage.sync
        );
        if (!isExtensionContext) {
          // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          const warningDiv = document.createElement("div");
          warningDiv.style.cssText = `
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-weight: bold;
          `;
          warningDiv.innerHTML = `
            âš ï¸ <strong>è­¦å‘Š:</strong> ã“ã®ãƒšãƒ¼ã‚¸ã¯Chromeæ‹¡å¼µæ©Ÿèƒ½ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>
            æ­£ã—ããƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®æ–¹æ³•ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š<br>
            1. æ‹¡å¼µæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã‚“ã§ã€chrome-extension:// URLã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹<br>
            2. ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸ã‹ã‚‰ã€Œãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã‚’é–‹ãã€ã‚’ã‚¯ãƒªãƒƒã‚¯<br>
            3. ãƒ–ãƒ©ã‚¦ã‚¶ã§æ‹¡å¼µæ©Ÿèƒ½ã¨ã—ã¦èª­ã¿è¾¼ã¿å¾Œã€ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã«: <code>chrome-extension://&lt;extension-id&gt;/tests/settings-integration-test.html</code>
          `;
          document.body.insertBefore(warningDiv, document.body.firstChild);
        }
        return isExtensionContext;
      }

      // ãƒ†ã‚¹ãƒˆçµæœã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
      function displayResult(testId, result, isSuccess = true) {
        const element = document.getElementById(testId);
        element.className = `test-result ${isSuccess ? "success" : "error"}`;
        element.textContent = result;
        testResults[testId] = { result, isSuccess };
      }

      function displayInfo(testId, info) {
        const element = document.getElementById(testId);
        element.className = "test-result info";
        element.textContent = info;
      }

      // 1. åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
      async function testBasicLoadSave() {
        if (!isExtensionContext) {
          displayResult(
            "test-basic-result",
            "ã‚¹ã‚­ãƒƒãƒ— (Chrome APIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“)",
            false
          );
          return;
        }

        try {
          displayInfo("test-basic-result", "åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...");

          // è¨­å®šèª­ã¿è¾¼ã¿
          const settings = await window.ChronoClipSettings.getSettings();
          console.log("Loaded settings:", settings);

          // è¨­å®šä¿å­˜ãƒ†ã‚¹ãƒˆ
          const testPatch = { autoDetect: !settings.autoDetect };
          const updatedSettings = await window.ChronoClipSettings.setSettings(
            testPatch
          );

          // å…ƒã«æˆ»ã™
          await window.ChronoClipSettings.setSettings({
            autoDetect: settings.autoDetect,
          });

          displayResult(
            "test-basic-result",
            `âœ… åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆæˆåŠŸ: è¨­å®šã®èª­ã¿è¾¼ã¿ãƒ»ä¿å­˜ãŒæ­£å¸¸ã«å‹•ä½œ`,
            true
          );
        } catch (error) {
          displayResult(
            "test-basic-result",
            `âŒ åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`,
            false
          );
        }
      }

      // 2. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
      async function testValidation() {
        if (!isExtensionContext) {
          displayResult(
            "test-validation-result",
            "ã‚¹ã‚­ãƒƒãƒ— (Chrome APIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“)",
            false
          );
          return;
        }

        try {
          displayInfo(
            "test-validation-result",
            "ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
          );

          const validationTests = [
            // ç„¡åŠ¹ãªdefaultDuration
            {
              defaultDuration: -1,
              expectError: true,
              name: "negative duration",
            },
            {
              defaultDuration: 2000,
              expectError: true,
              name: "too large duration",
            },
            // ç„¡åŠ¹ãªdateFormats
            { dateFormats: [], expectError: true, name: "empty dateFormats" },
            {
              dateFormats: ["INVALID"],
              expectError: true,
              name: "invalid dateFormat",
            },
            // ç„¡åŠ¹ãªtimezone
            { timezone: "", expectError: true, name: "empty timezone" },
            // æœ‰åŠ¹ãªè¨­å®š
            {
              defaultDuration: 120,
              dateFormats: ["JP", "US"],
              timezone: "Asia/Tokyo",
              expectError: false,
              name: "valid settings",
            },
          ];

          let passCount = 0;
          let totalCount = validationTests.length;

          for (const test of validationTests) {
            try {
              await window.ChronoClipSettings.setSettings(test);
              if (test.expectError) {
                console.warn(`Expected error for ${test.name}, but succeeded`);
              } else {
                passCount++;
              }
            } catch (error) {
              if (test.expectError) {
                passCount++;
              } else {
                console.error(`Unexpected error for ${test.name}:`, error);
              }
            }
          }

          displayResult(
            "test-validation-result",
            `âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ: ${passCount}/${totalCount} ãƒ†ã‚¹ãƒˆãŒæœŸå¾…é€šã‚Šã«å‹•ä½œ`,
            passCount === totalCount
          );
        } catch (error) {
          displayResult(
            "test-validation-result",
            `âŒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`,
            false
          );
        }
      }

      // 3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
      async function testMigration() {
        if (!isExtensionContext) {
          displayResult(
            "test-migration-result",
            "ã‚¹ã‚­ãƒƒãƒ— (Chrome APIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“)",
            false
          );
          return;
        }

        try {
          displayInfo(
            "test-migration-result",
            "ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
          );

          // å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è¨­å®šã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
          const oldSettings = { autoDetect: true, version: 0 };

          // Chrome Storage ã«ç›´æ¥å¤ã„è¨­å®šã‚’ä¿å­˜
          await chrome.storage.sync.set({ chronoClipSettings: oldSettings });

          // è¨­å®šã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
          const migratedSettings =
            await window.ChronoClipSettings.getSettings();

          if (
            migratedSettings.version === 1 &&
            migratedSettings.highlightDates !== undefined
          ) {
            displayResult(
              "test-migration-result",
              `âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆæˆåŠŸ: v0 â†’ v1 ã«æ­£å¸¸ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³`,
              true
            );
          } else {
            displayResult(
              "test-migration-result",
              `âŒ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—: æœŸå¾…ã—ãŸçµæœã«ãªã‚Šã¾ã›ã‚“ã§ã—ãŸ`,
              false
            );
          }
        } catch (error) {
          displayResult(
            "test-migration-result",
            `âŒ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`,
            false
          );
        }
      }

      // 4. ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ†ã‚¹ãƒˆ
      async function testBroadcast() {
        if (!isExtensionContext) {
          displayResult(
            "test-broadcast-result",
            "ã‚¹ã‚­ãƒƒãƒ— (Chrome APIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“)",
            false
          );
          return;
        }

        try {
          displayInfo(
            "test-broadcast-result",
            "ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
          );

          let broadcastReceived = false;
          let broadcastData = null;

          // ä¸€æ™‚çš„ãªãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²
          const tempListener = (settings) => {
            broadcastReceived = true;
            broadcastData = settings;
          };

          window.ChronoClipSettings.onSettingsChanged(tempListener);

          // è¨­å®šå¤‰æ›´ï¼ˆãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ï¼‰
          await window.ChronoClipSettings.setSettings({ defaultDuration: 150 });

          // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒã‚§ãƒƒã‚¯
          setTimeout(() => {
            window.ChronoClipSettings.removeSettingsListener(tempListener);

            if (
              broadcastReceived &&
              broadcastData &&
              broadcastData.defaultDuration === 150
            ) {
              displayResult(
                "test-broadcast-result",
                `âœ… ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ†ã‚¹ãƒˆæˆåŠŸ: è¨­å®šå¤‰æ›´ãŒæ­£å¸¸ã«é€šçŸ¥ã•ã‚ŒãŸ`,
                true
              );
            } else {
              displayResult(
                "test-broadcast-result",
                `âŒ ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆå¤±æ•—: é€šçŸ¥ãŒå—ä¿¡ã•ã‚Œãªã‹ã£ãŸ`,
                false
              );
            }
          }, 200);
        } catch (error) {
          displayResult(
            "test-broadcast-result",
            `âŒ ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`,
            false
          );
        }
      }

      // 5. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨­å®šç›£è¦–
      function startSettingsWatch() {
        if (watchListener) {
          stopSettingsWatch();
        }

        watchListener = (settings) => {
          const timestamp = new Date().toLocaleTimeString();
          const info = `[${timestamp}] è¨­å®šå¤‰æ›´æ¤œå‡º: autoDetect=${settings.autoDetect}, highlightDates=${settings.highlightDates}, defaultDuration=${settings.defaultDuration}åˆ†`;
          displayInfo("test-watch-result", info);
        };

        window.ChronoClipSettings.onSettingsChanged(watchListener);
        displayInfo(
          "test-watch-result",
          "â±ï¸ è¨­å®šå¤‰æ›´ã®ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼ˆè¨­å®šãƒšãƒ¼ã‚¸ã§å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰"
        );
      }

      function stopSettingsWatch() {
        if (watchListener) {
          window.ChronoClipSettings.removeSettingsListener(watchListener);
          watchListener = null;
          displayInfo("test-watch-result", "â¹ï¸ è¨­å®šå¤‰æ›´ã®ç›£è¦–ã‚’åœæ­¢ã—ã¾ã—ãŸ");
        }
      }

      // ç¾åœ¨ã®è¨­å®šè¡¨ç¤º
      async function displayCurrentSettings() {
        if (!isExtensionContext) {
          document.getElementById("current-settings").textContent =
            "Chromeæ‹¡å¼µæ©Ÿèƒ½ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å®Ÿè¡Œã—ã¦ãã ã•ã„";
          return;
        }

        try {
          const settings = await window.ChronoClipSettings.getSettings();
          document.getElementById("current-settings").textContent =
            JSON.stringify(settings, null, 2);
        } catch (error) {
          document.getElementById(
            "current-settings"
          ).textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        }
      }

      // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      async function loadTestSettings() {
        if (!isExtensionContext) {
          alert("Chromeæ‹¡å¼µæ©Ÿèƒ½ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å®Ÿè¡Œã—ã¦ãã ã•ã„");
          return;
        }

        try {
          const testSettings = {
            autoDetect: false,
            highlightDates: true,
            defaultDuration: 90,
            defaultCalendar: "test-calendar",
            timezone: "America/New_York",
            includeURL: false,
            dateFormats: ["US", "ISO"],
            rulesEnabled: true,
            siteRules: {
              "example.com": {
                enabled: true,
                selectors: [".event-date", ".schedule-time"],
              },
            },
          };

          await window.ChronoClipSettings.setSettings(testSettings);
          displayCurrentSettings();
          alert("ãƒ†ã‚¹ãƒˆç”¨è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
        } catch (error) {
          alert(`ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
      }

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆ
      async function resetToDefault() {
        if (!isExtensionContext) {
          alert("Chromeæ‹¡å¼µæ©Ÿèƒ½ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å®Ÿè¡Œã—ã¦ãã ã•ã„");
          return;
        }

        try {
          await window.ChronoClipSettings.resetToDefault();
          displayCurrentSettings();
          alert("è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
        } catch (error) {
          alert(`ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
      }

      // è¨­å®šãƒšãƒ¼ã‚¸ã‚’é–‹ã
      function openOptionsPage() {
        chrome.runtime.openOptionsPage();
      }

      // å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      async function runAllTests() {
        if (!checkExtensionContext()) {
          alert(
            "Chromeæ‹¡å¼µæ©Ÿèƒ½ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚\n\næ‹¡å¼µæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã¿å¾Œã€chrome-extension:// URLã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚"
          );
          return;
        }

        clearResults();
        await testBasicLoadSave();
        await new Promise((resolve) => setTimeout(resolve, 500));
        await testValidation();
        await new Promise((resolve) => setTimeout(resolve, 500));
        await testMigration();
        await new Promise((resolve) => setTimeout(resolve, 500));
        await testBroadcast();

        displayCurrentSettings();
      }

      // çµæœã‚¯ãƒªã‚¢
      function clearResults() {
        const resultElements = document.querySelectorAll(".test-result");
        resultElements.forEach((element) => {
          element.className = "test-result";
          element.textContent = "";
        });
        testResults = {};
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
      document.addEventListener("DOMContentLoaded", () => {
        // Chrome APIåˆ©ç”¨å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯
        checkExtensionContext();

        if (isExtensionContext) {
          displayCurrentSettings();
          console.log(
            "ChronoClip è¨­å®šã‚·ã‚¹ãƒ†ãƒ çµ±åˆãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ (Chromeæ‹¡å¼µæ©Ÿèƒ½ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ)"
          );
        } else {
          console.warn(
            "ChronoClip è¨­å®šã‚·ã‚¹ãƒ†ãƒ çµ±åˆãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ (é€šå¸¸ã®Webãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ - APIãƒ†ã‚¹ãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™)"
          );
        }
      });
    </script>
  </body>
</html>
