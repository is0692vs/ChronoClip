# Multi-Calendar Support Testing Guide

## テスト環境のセットアップ (Test Environment Setup)

### 1. OAuth設定 (OAuth Configuration)

1. Google Cloud Consoleで新しいプロジェクトを作成（または既存のプロジェクトを使用）
2. Google Calendar APIを有効化
3. OAuth 2.0クライアントIDを作成（アプリケーションの種類: Chrome拡張機能）
4. 以下のスコープが含まれていることを確認:
   - `https://www.googleapis.com/auth/calendar.events`
   - `https://www.googleapis.com/auth/calendar.readonly`
   - `https://www.googleapis.com/auth/userinfo.email`
   - `https://www.googleapis.com/auth/userinfo.profile`

### 2. 拡張機能のインストール (Extension Installation)

```bash
# manifest.jsonを作成
cp manifest.example.json manifest.json

# OAuth Client IDを設定（manifest.jsonを編集）
# "YOUR_GOOGLE_CLOUD_OAUTH_CLIENT_ID.apps.googleusercontent.com" を
# 自分のClient IDに置き換え
```

## テストケース (Test Cases)

### ✅ TC1: カレンダーリストの取得 (Calendar List Fetching)

**前提条件:**
- Googleアカウントに複数のカレンダーが存在する
- 拡張機能がインストールされている

**手順:**
1. Chrome拡張機能の設定ページを開く
2. 「追加先カレンダー」セクションを確認

**期待される結果:**
- カレンダードロップダウンに、Googleアカウントのすべてのカレンダーが表示される
- プライマリカレンダーには「(プライマリ)」ラベルが付く
- カレンダー名が正しく表示される

**確認ポイント:**
- [ ] カレンダーリストが自動的に読み込まれる
- [ ] プライマリカレンダーが識別される
- [ ] すべてのカレンダー（共有カレンダーを含む）が表示される

---

### ✅ TC2: デフォルトカレンダーの選択と保存 (Default Calendar Selection)

**前提条件:**
- TC1が完了している
- カレンダーリストが表示されている

**手順:**
1. 「追加先カレンダー」ドロップダウンから非プライマリカレンダーを選択
2. 「設定を保存」ボタンをクリック
3. ページをリロード

**期待される結果:**
- 設定が正常に保存される
- リロード後も選択したカレンダーが保持される
- 「保存済み」トーストメッセージが表示される

**確認ポイント:**
- [ ] 選択したカレンダーが保存される
- [ ] リロード後も設定が保持される
- [ ] 保存成功のフィードバックが表示される

---

### ✅ TC3: カレンダーリストの手動更新 (Manual Calendar Refresh)

**前提条件:**
- TC1が完了している
- 設定ページが開いている

**手順:**
1. 別タブでGoogle Calendarを開き、新しいカレンダーを作成
2. 設定ページに戻り、🔄ボタンをクリック

**期待される結果:**
- カレンダーリストが更新される
- 新しく作成したカレンダーがドロップダウンに表示される
- 「カレンダーリストを更新しました」メッセージが表示される

**確認ポイント:**
- [ ] 更新ボタンが機能する
- [ ] 新しいカレンダーが表示される
- [ ] 更新中はボタンが無効化される

---

### ✅ TC4: ポップアップでのカレンダー表示 (Popup Calendar Display)

**前提条件:**
- TC2が完了している
- デフォルトカレンダーが設定されている

**手順:**
1. 拡張機能のポップアップを開く（ツールバーアイコンをクリック）
2. 「現在の設定」セクションを確認

**期待される結果:**
- 選択したデフォルトカレンダー名が表示される
- カレンダー名の表示形式が正しい

**確認ポイント:**
- [ ] デフォルトカレンダー名が表示される
- [ ] カレンダー: [カレンダー名] の形式で表示される

---

### ✅ TC5: クイック追加ポップアップでのカレンダー選択 (Quick Add Calendar Selection)

**前提条件:**
- TC2が完了している
- Webページ上で日付が検出される

**手順:**
1. 日付をハイライトしているページを開く
2. ハイライトされた日付をクリック
3. クイック追加ポップアップを確認
4. 「Calendar」ドロップダウンを確認

**期待される結果:**
- カレンダードロップダウンが表示される
- デフォルトで設定画面で選択したカレンダーが選択されている
- すべてのカレンダーが選択可能

**確認ポイント:**
- [ ] カレンダー選択ドロップダウンが表示される
- [ ] デフォルトカレンダーが事前選択されている
- [ ] 他のカレンダーも選択可能

---

### ✅ TC6: イベントの追加（選択したカレンダーへ）(Event Creation to Selected Calendar)

**前提条件:**
- TC5が完了している
- クイック追加ポップアップが開いている

**手順:**
1. イベント情報を入力:
   - Title: "テストイベント"
   - Date: 明日の日付
   - Details: "マルチカレンダーテスト"
2. 「Calendar」ドロップダウンから特定のカレンダーを選択
3. 「Add」ボタンをクリック
4. Google Calendarを開いて確認

**期待される結果:**
- イベントが選択したカレンダーに追加される
- プライマリカレンダーではなく、選択したカレンダーに表示される
- イベント詳細が正しく保存される

**確認ポイント:**
- [ ] イベントが正しいカレンダーに追加される
- [ ] イベント情報が正確に保存される
- [ ] 成功メッセージが表示される

---

### ✅ TC7: 異なるカレンダーへの複数イベント追加 (Multiple Events to Different Calendars)

**前提条件:**
- TC6が完了している
- 複数のカレンダーが利用可能

**手順:**
1. イベント1をカレンダーAに追加
2. イベント2をカレンダーBに追加
3. イベント3をプライマリカレンダーに追加
4. Google Calendarで各カレンダーを確認

**期待される結果:**
- 各イベントが指定したカレンダーに正しく追加される
- カレンダー間でイベントが混在しない

**確認ポイント:**
- [ ] 各イベントが正しいカレンダーに配置される
- [ ] カレンダーの切り替えが正しく動作する
- [ ] 同時に複数のカレンダーを使用できる

---

### ✅ TC8: キャッシュの動作確認 (Cache Behavior)

**前提条件:**
- カレンダーリストが一度取得されている

**手順:**
1. 設定ページを開く（カレンダーリストが読み込まれる）
2. ブラウザの開発者ツールでネットワークタブを開く
3. ページをリロード
4. 1時間後に再度リロード

**期待される結果:**
- 最初のリロード時はキャッシュが使用される（APIコールなし）
- 1時間後のリロードではAPIが呼ばれる
- コンソールに「Using cached calendar list」が表示される

**確認ポイント:**
- [ ] 1時間以内はキャッシュが使用される
- [ ] 1時間後は自動的に更新される
- [ ] 不要なAPI呼び出しが削減される

---

### ✅ TC9: エラーハンドリング（認証エラー）(Error Handling - Auth Error)

**前提条件:**
- 拡張機能がインストールされている
- Googleアカウントからログアウト状態

**手順:**
1. 設定ページを開く
2. カレンダーリストの取得を試みる

**期待される結果:**
- エラーが適切に処理される
- フォールバック動作（プライマリカレンダーのみ表示）
- ユーザーに認証を促すメッセージ（または適切なエラーメッセージ）

**確認ポイント:**
- [ ] エラーが適切に処理される
- [ ] アプリケーションがクラッシュしない
- [ ] フォールバック動作が正常

---

### ✅ TC10: 後方互換性 (Backward Compatibility)

**前提条件:**
- 古い設定データ（calendarListなし）が存在する

**手順:**
1. Chrome Storage APIから `calendarList` フィールドを削除
2. 拡張機能を再読み込み
3. 設定ページを開く

**期待される結果:**
- 古い設定でも正常に動作する
- デフォルトで「primary」カレンダーが使用される
- カレンダーリストが自動的に取得される

**確認ポイント:**
- [ ] 既存のユーザー設定が壊れない
- [ ] スムーズに新機能へ移行できる
- [ ] デフォルト値が正しく適用される

---

## パフォーマンステスト (Performance Tests)

### PT1: カレンダーリスト取得の応答時間

**許容範囲:** < 3秒

**測定方法:**
```javascript
console.time('fetchCalendars');
await fetchAndCacheCalendarList();
console.timeEnd('fetchCalendars');
```

**確認ポイント:**
- [ ] 初回取得が3秒以内
- [ ] キャッシュ使用時は即座（< 100ms）

---

### PT2: メモリ使用量

**許容範囲:** カレンダーリストキャッシュによる増加 < 1MB

**確認ポイント:**
- [ ] メモリリークがない
- [ ] キャッシュデータが適切にクリーンアップされる

---

## セキュリティテスト (Security Tests)

### ST1: OAuth認証フロー

**確認ポイント:**
- [ ] トークンが安全に保存される
- [ ] 必要最小限のスコープのみが要求される
- [ ] トークンの有効期限が適切に処理される

---

### ST2: データの保護

**確認ポイント:**
- [ ] カレンダーデータが暗号化されていない形でログに出力されない
- [ ] センシティブ情報がコンソールに表示されない（本番ビルドで）

---

## テスト結果サマリー (Test Results Summary)

実施日: YYYY-MM-DD
テスター: [名前]

| テストケース | 結果 | 備考 |
|------------|------|------|
| TC1 | ✅ / ❌ | |
| TC2 | ✅ / ❌ | |
| TC3 | ✅ / ❌ | |
| TC4 | ✅ / ❌ | |
| TC5 | ✅ / ❌ | |
| TC6 | ✅ / ❌ | |
| TC7 | ✅ / ❌ | |
| TC8 | ✅ / ❌ | |
| TC9 | ✅ / ❌ | |
| TC10 | ✅ / ❌ | |

---

## 既知の問題 (Known Issues)

*テスト中に発見された問題をここに記録*

---

## 改善提案 (Improvement Suggestions)

*テスト中に気づいた改善点をここに記録*
